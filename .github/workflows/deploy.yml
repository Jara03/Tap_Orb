name: Upload Xcode project to Hackintosh VM

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  upload_xcode_project:
    runs-on: [self-hosted]

    steps:
      # ✅ Ici tu gardes ton build Unity iOS habituel (si tu l'as déjà).
      # L'objectif: produire Build\iOS dans $GITHUB_WORKSPACE

      - name: Verify iOS Xcode project exists
        shell: powershell
        run: |
          $iosPath = Join-Path $env:GITHUB_WORKSPACE "Build\iOS"
          Write-Host "Expected iOS build folder: $iosPath"
          if (!(Test-Path $iosPath)) {
            Write-Error "Build output not found: $iosPath"
            exit 1
          }
          Write-Host "Top-level content:"
          Get-ChildItem $iosPath | Select-Object -First 30 | Format-Table Name

      - name: Pack Xcode project folder (zip)
        shell: powershell
        run: |
          $iosPath = Join-Path $env:GITHUB_WORKSPACE "Build\iOS"
          $zipPath = Join-Path $env:GITHUB_WORKSPACE "xcode_project.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $iosPath "*") -DestinationPath $zipPath
          Write-Host "Created zip: $zipPath"
          Get-Item $zipPath | Format-List Name,Length,FullName
  
           - name: Setup SSH (fresh)
          shell: powershell
          env:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            KNOWN_HOSTS: ${{ secrets.KNOWN_HOSTS }}
          run: |
            $sshDir = Join-Path $env:RUNNER_TEMP ("ssh_ci_" + $env:GITHUB_RUN_ID)
            if (Test-Path $sshDir) { Remove-Item $sshDir -Recurse -Force }
            New-Item -ItemType Directory -Force -Path $sshDir | Out-Null
        
            $keyPath = Join-Path $sshDir "id_ed25519"
            Set-Content -Path $keyPath -Value ($env:SSH_PRIVATE_KEY -replace "`r","") -NoNewline -Encoding ascii
        
            $knownHostsPath = Join-Path $sshDir "known_hosts"
            Set-Content -Path $knownHostsPath -Value ($env:KNOWN_HOSTS -replace "`r","") -Encoding ascii
        
            "SSH_KEY=$keyPath" | Out-File -FilePath $env:GITHUB_ENV -Append
            "SSH_KNOWN_HOSTS=$knownHostsPath" | Out-File -FilePath $env:GITHUB_ENV -Append


      - name: SSH test
        shell: powershell
        env:
          DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
          DEPLOY_USER: ${{ vars.DEPLOY_USER }}
          DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
        run: |
          ssh -o BatchMode=yes -o ConnectTimeout=10 -o ConnectionAttempts=1 `
            -i "$env:SSH_KEY" -p $env:DEPLOY_PORT `
            -o UserKnownHostsFile="$env:SSH_KNOWN_HOSTS" `
            -o StrictHostKeyChecking=yes `
            "$($env:DEPLOY_USER)@$($env:DEPLOY_HOST)" "echo SSH_OK && sw_vers && whoami"
      
      - name: SCP upload
        shell: powershell
        env:
          DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
          DEPLOY_USER: ${{ vars.DEPLOY_USER }}
          DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
        run: |
          scp -i "$env:SSH_KEY" -P $env:DEPLOY_PORT `
            -o UserKnownHostsFile="$env:SSH_KNOWN_HOSTS" `
            -o StrictHostKeyChecking=yes `
            "$env:GITHUB_WORKSPACE\xcode_project.tar.gz" `
            "$($env:DEPLOY_USER)@$($env:DEPLOY_HOST):/Users/hayro/TapOrbBuilds/xcode_project.tar.gz"

          # Unzip dans iOS/ puis symlink current -> iOS
          ssh -p $env:DEPLOY_PORT "$($env:DEPLOY_USER)@$($env:DEPLOY_HOST)" @"
          set -e
          cd '$releaseDir'
          rm -rf iOS
          mkdir -p iOS
          unzip -q xcode_project.zip -d iOS
          rm -f xcode_project.zip
          ln -sfn '$releaseDir/iOS' '$($env:DEPLOY_PATH)/current'
          echo 'DEPLOY OK'
          echo 'current -> ' \$(readlink '$($env:DEPLOY_PATH)/current')
