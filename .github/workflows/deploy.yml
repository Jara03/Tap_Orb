name: Build iOS + Upload to VM

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: [self-hosted, Windows, X64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- (OPTIONNEL) Ton vrai build ici ---
      # Remplace par ton step Unity/iOS si besoin.
      # L'important: à la fin, tu dois avoir $GITHUB_WORKSPACE\Build\iOS

      - name: Verify iOS build output exists
        shell: pwsh
        run: |
          $iosPath = Join-Path $env:GITHUB_WORKSPACE "Build\iOS"
          Write-Host "Looking for: $iosPath"
          if (!(Test-Path $iosPath)) {
            Write-Error "Build output not found: $iosPath"
            exit 1
          }
          Get-ChildItem $iosPath | Select-Object -First 20 | Format-Table

      - name: Pack iOS build folder as zip
        shell: pwsh
        run: |
          $iosPath = Join-Path $env:GITHUB_WORKSPACE "Build\iOS"
          $outZip  = Join-Path $env:GITHUB_WORKSPACE "ios_build.zip"
          if (Test-Path $outZip) { Remove-Item $outZip -Force }
          Compress-Archive -Path (Join-Path $iosPath "*") -DestinationPath $outZip
          Write-Host "Created: $outZip"
          Get-Item $outZip | Format-List Name,Length,FullName

      - name: Setup SSH key + known_hosts
        shell: pwsh
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
          KNOWN_HOSTS: ${{ secrets.KNOWN_HOSTS }}
        run: |
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          New-Item -ItemType Directory -Force -Path $sshDir | Out-Null

          $keyPath = Join-Path $sshDir "id_ed25519"
          # Ecrit la clé (en évitant les CRLF parasites)
          $key = $env:SSH_PRIVATE_KEY -replace "`r",""
          Set-Content -Path $keyPath -Value $key -NoNewline -Encoding ascii

          # Permissions Windows (important sinon ssh refuse parfois)
          icacls $keyPath /inheritance:r | Out-Null
          icacls $keyPath /grant:r "$($env:USERNAME):(R)" | Out-Null

          $knownHostsPath = Join-Path $sshDir "known_hosts"
          if ($env:KNOWN_HOSTS -and $env:KNOWN_HOSTS.Trim().Length -gt 0) {
            Set-Content -Path $knownHostsPath -Value ($env:KNOWN_HOSTS -replace "`r","") -Encoding ascii
          } else {
            # Fallback: génère known_hosts en CI
            ssh-keyscan -p $env:DEPLOY_PORT $env:DEPLOY_HOST | Out-File -FilePath $knownHostsPath -Encoding ascii
          }

          Write-Host "SSH prepared."
          Write-Host "known_hosts:"
          Get-Content $knownHostsPath | Select-Object -First 5

      - name: SSH test (from CI runner)
        shell: pwsh
        env:
          DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
          DEPLOY_USER: ${{ vars.DEPLOY_USER }}
          DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
        run: |
          ssh -p $env:DEPLOY_PORT "$($env:DEPLOY_USER)@$($env:DEPLOY_HOST)" "echo SSH_OK && hostname && whoami"

      - name: Upload zip to VM + versioned release + atomic current
        shell: pwsh
        env:
          DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
          DEPLOY_USER: ${{ vars.DEPLOY_USER }}
          DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
          SHA: ${{ github.sha }}
        run: |
          $short = $env:SHA.Substring(0,7)
          $releaseDir = "$($env:DEPLOY_PATH)/releases/$short"
          $zipLocal = Join-Path $env:GITHUB_WORKSPACE "ios_build.zip"

          # mkdir remote
          ssh -p $env:DEPLOY_PORT "$($env:DEPLOY_USER)@$($env:DEPLOY_HOST)" "mkdir -p '$releaseDir' '$($env:DEPLOY_PATH)/releases'"

          # upload
          scp -P $env:DEPLOY_PORT $zipLocal "$($env:DEPLOY_USER)@$($env:DEPLOY_HOST):$releaseDir/ios_build.zip"

          # unzip + symlink current (Linux VM)
          ssh -p $env:DEPLOY_PORT "$($env:DEPLOY_USER)@$($env:DEPLOY_HOST)" @"
          set -e
          cd '$releaseDir'
          rm -rf iOS
          mkdir -p iOS
          unzip -q ios_build.zip -d iOS
          rm -f ios_build.zip
          ln -sfn '$releaseDir/iOS' '$($env:DEPLOY_PATH)/current'
          echo 'Deployed current ->' && readlink -f '$($env:DEPLOY_PATH)/current'
"@
